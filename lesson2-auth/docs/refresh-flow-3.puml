@startuml Case3_Both401_Race_Interleaved
title Case 3 â€“ ĞĞ±Ğ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ÑÑ‚ 401, Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ mutex, Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ¶Ğ´Ñ‘Ñ‚

participant "Thread #1" as T1
participant "Thread #2" as T2
participant Mutex
participant "Resource API" as API
participant "Auth /refresh" as AUTH

== T1 Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ ==
T1 -> Mutex : waitForUnlock()
Mutex --> T1
T1 -> API   : baseQueryWithAccessToken(argsâ‚)

== T2 Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ ÑÑ‚Ğ°Ñ€Ñ‚ÑƒĞµÑ‚ ==
T2 -> Mutex : waitForUnlock()
Mutex --> T2
T2 -> API   : baseQueryWithAccessToken(argsâ‚‚)

== ĞĞ±Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ÑÑ‚ 401 ==
API --> T1  : 401 Unauthorized
API --> T2  : 401 Unauthorized

== T1 Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ³Ğ¾Ğ½ĞºÑƒ Ğ·Ğ° mutex ==
T1 -> Mutex : acquire() ğŸ”’
Mutex --> T1

== T2 Ğ·Ğ°Ğ¼ĞµÑ‡Ğ°ĞµÑ‚, Ñ‡Ñ‚Ğ¾ mutex Ğ·Ğ°Ğ½ÑÑ‚ ==
T2 -> Mutex : isLocked() â†’ true
T2 -> Mutex : waitForUnlock()
note right of T2 : Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ, Ğ¶Ğ´Ñ‘Ñ‚ release

== T1 Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½ ==
T1 -> AUTH  : POST /auth/refresh
AUTH --> T1 : 200 OK (new token)

== T1 Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµÑ‚ ÑĞ²Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ==
T1 -> API : baseQueryWithAccessToken(argsâ‚) (retry)
API --> T1 : 200 OK

== T1 Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´Ğ°ĞµÑ‚ Ğ¼ÑŒÑÑ‚ĞµĞºÑ ==
T1 -> Mutex : release() ğŸ”“
Mutex --> T1

== T2 Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµÑ‚ ==
T2 --> Mutex : unblocked
T2 -> API : baseQueryWithAccessToken(argsâ‚‚) (retry)
API --> T2 : 200 OK

@enduml
