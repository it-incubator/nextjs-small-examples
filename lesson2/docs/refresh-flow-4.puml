@startuml Case4_RefreshFails_Interleaved
title Case 4 â€“ Refresh token Ñ‚Ğ¾Ğ¶Ğµ Ğ¸ÑÑ‚Ñ‘Ğº âœ logout

participant "Thread #1" as T1
participant Mutex
participant "Resource API" as API
participant "Auth /refresh" as AUTH
participant "Frontend Store\n(dispatch loggedOut)" as STORE

== T1 Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ==
T1 -> Mutex : waitForUnlock()
Mutex --> T1
T1 -> API   : baseQueryWithAccessToken(args)
API --> T1  : 401 Unauthorized

== T1 Ğ¿Ñ‹Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½ ==
T1 -> Mutex : acquire() ğŸ”’
Mutex --> T1
T1 -> AUTH  : POST /auth/refresh
AUTH --> T1 : 401 Unauthorized (refresh Ñ‚Ğ¾ĞºĞµĞ½ Ğ¿Ñ€Ğ¾Ñ‚ÑƒÑ…)

== T1 Ğ²Ñ‹Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ==
T1 -> STORE : dispatch(loggedOut)
note right: clear auth state,\nredirect to /login, etc.

== T1 Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´Ğ°ĞµÑ‚ Ğ¼ÑŒÑÑ‚ĞµĞºÑ ==
T1 -> Mutex : release() ğŸ”“
Mutex --> T1

@enduml
