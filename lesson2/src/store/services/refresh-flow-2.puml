@startuml Case2_SecondWaits_Interleaved
title Case 2 â€“ Refresh in progress, second thread arrives during it

participant "Thread #1" as T1
participant "Thread #2" as T2
participant Mutex
participant "Resource API" as API
participant "Auth /refresh" as AUTH

== T1 Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ==
T1 -> Mutex : waitForUnlock()
Mutex --> T1
T1 -> API   : baseQueryWithAccessToken(argsâ‚)
API --> T1  : 401 Unauthorized

== T1 Ğ¿Ñ‹Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½ ==
T1 -> Mutex : acquire() ğŸ”’
Mutex --> T1
T1 -> AUTH  : POST /auth/refresh

== Ğ’ ÑÑ‚Ğ¾ Ğ¶Ğµ Ğ²Ñ€ĞµĞ¼Ñ T2 ÑÑ‚Ğ°Ñ€Ñ‚ÑƒĞµÑ‚ ==
T2 -> Mutex : waitForUnlock()
note right of T2 : T2 Ğ¶Ğ´Ñ‘Ñ‚, mutex Ğ¿Ğ¾ĞºĞ° Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½

== T1 Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ==
AUTH --> T1 : 200 OK (new token)
T1 -> Mutex : release() ğŸ”“
Mutex --> T1

== T2 Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµÑ‚ Ğ¿Ğ¾ÑĞ»Ğµ release ==
T2 --> Mutex : unblocked
T2 -> API    : baseQueryWithAccessToken(argsâ‚‚)
API --> T2   : 200 OK (assumes valid new token)

== T1 Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµÑ‚ ÑĞ²Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ==
T1 -> API    : baseQueryWithAccessToken(argsâ‚) (retry)
API --> T1   : 200 OK

@enduml
